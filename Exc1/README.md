centos7.json 

Упаковка образа Centos 7.9 NetInstall с помощью packer. Провайдер VirtulaBox 7.0.8. В процессе упаковки используется ВМ с 2 процессорными ядрами и 2 Гигабайт ОЗУ. 

Во время упаковки выяснилось, что ВМ получает ip из подсети отличной от хоста. Из-за этого в процеесе возникала недоступность конфигурационного файла и в целом хостовой машины из установщика. Решилось, добавлением следующего параметра в json:

"--nat-localhostreachable1",
"on"

Так же столкнулся с проблемой, при выполнении выключения/перезагрузки/запуске скриптов. Packer зависал в ожидании ввода пароля. И в итоге завершал работу по таймауту. Решшилось явной передачей пароля в команду выключения/перезагрузки/запуска скриптов. 

Например, для команды перезагрузки использовалось следующее. 

"echo 'vagrant' | {{.Vars}} sudo -S -E bash '{{.Path}}'"

В процессе создания коробки, используются два скрипта, которые устанавливают последнее доступное ядро stage-1-kernel-update.sh и stage-2-clean.sh, который выполняет окончательную настройку образа. 

stage-1-kernel-update.sh 

Устанавливает последнее ядро. Устанавливает это ядро используемым по умолчанию. 

stage-2-clean.sh

Обновляет систему. Очищает кэш репозитория. 

Добавляет группу vagrant с доступом к sudo без пароля. Это обязательное требование vagrant. Так же добавляется небезопасный ключ, для доступа к ВМ по ключу. 

В sshd_config добавляется параметр UseDNS = no, по умолчанию установлен в yes. Из-за этого после запуска коробки могут возникнуть проблемы с ssh соединением. 

Далее удалляются кэш, логи и т.д. 

И еще раз устанавливаем ядро загрузки, так как после команды обновления, устанавливается новое, и порядковый номер ядра меняет свое значение. 


